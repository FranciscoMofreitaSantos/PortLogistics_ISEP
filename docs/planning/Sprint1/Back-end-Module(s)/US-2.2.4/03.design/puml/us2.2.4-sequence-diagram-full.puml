@startuml
actor "Port Authority Officer" as Officer
boundary "API Controller" as Controller
control "StorageAreaService" as Service
entity "StorageAreaRepository" as Repo
entity "PhysicalResourceRepository" as PRRepo
control "StorageAreaFactory" as Factory
database "Audit Log" as Audit

title Sequence Diagram â€“ US2.2.4 Register, Update & Query Storage Areas

== Create Storage Area ==
Officer -> Controller : POST /api/storageareas {dto}
Controller -> Service : CreateAsync(dto)
Service -> Repo : GetByNameAsync(dto.Name)
Repo --> Service : null

loop Validate Physical Resources
    Service -> PRRepo : GetByCodeAsync(code)
    PRRepo --> Service : PhysicalResource or null
    Service -> Service : throw BusinessRuleValidationException() if null
end

Service -> Factory : CreateStorageArea(dto)
Factory --> Service : StorageArea

Service -> Repo : AddAsync(storageArea)
Repo --> Service : ok
Service -> Repo : CommitAsync()
Repo --> Service : ok

Service -> Audit : log(CREATE, officerId, storageArea.Name, timestamp)
Service --> Controller : StorageAreaDto
Controller --> Officer : 201 Created (StorageAreaDto)

== Error: Duplicate Name ==
Officer -> Controller : POST /api/storageareas (duplicate name)
Controller -> Service : CreateAsync(dto)
Service -> Repo : GetByNameAsync(dto.Name)
Repo --> Service : StorageArea (exists)
Service -> Service : throw BusinessRuleValidationException("already exists")
Controller --> Officer : 409 Conflict (BusinessRuleValidationException)

== Update Storage Area ==
Officer -> Controller : PATCH /api/storageareas/{id} {dto}
Controller -> Service : UpdateAsync(id, dto)
Service -> Repo : GetByIdAsync(id)
Repo --> Service : StorageArea or null

alt not found
    Service -> Service : throw BusinessRuleValidationException("not found")
    Controller --> Officer : 404 Not Found
else found
    Service -> Service : Apply updates (description?, type?, docks?, resources?)
    Service -> Repo : CommitAsync()
    Repo --> Service : ok
    Service -> Audit : log(UPDATE, officerId, id, timestamp)
    Service --> Controller : Updated StorageAreaDto
    Controller --> Officer : 200 OK (StorageAreaDto)
end

== Get All Storage Areas ==
Officer -> Controller : GET /api/storageareas
Controller -> Service : GetAllAsync()
Service -> Repo : GetAllAsync()
Repo --> Service : List<StorageArea>
Service -> Factory : CreateStorageAreaDto(area*)
Factory --> Service : List<StorageAreaDto>
Service --> Controller : List<StorageAreaDto>
Controller --> Officer : 200 OK (StorageAreaDto*)

== Get Distances to Docks ==
Officer -> Controller : GET /api/storageareas/distances?name=x&id=y
Controller -> Service : GetDistancesToDockAsync(name?, id?)
Service -> Repo : GetByNameAsync(name) OR GetByIdAsync(id)
Repo --> Service : StorageArea or null

alt found
    Service -> Service : Extract Distances (DockCode, DistanceKm)
    Service --> Controller : List<StorageAreaDockDistanceDto>
    Controller --> Officer : 200 OK (StorageAreaDockDistanceDto*)
else not found
    Service -> Service : throw BusinessRuleValidationException("not found")
    Controller --> Officer : 404 Not Found
end

== Get Physical Resources ==
Officer -> Controller : GET /api/storageareas/physicalresources?name=x&id=y
Controller -> Service : GetPhysicalResourcesAsync(name?, id?)
Service -> Repo : GetByNameAsync(name) OR GetByIdAsync(id)
Repo --> Service : StorageArea or null

alt found
    Service -> Service : Extract PhysicalResources (List<string>)
    Service --> Controller : List<string>
    Controller --> Officer : 200 OK (PhysicalResourceCode*)
else not found
    Service -> Service : throw BusinessRuleValidationException("not found")
    Controller --> Officer : 404 Not Found
end

@enduml
