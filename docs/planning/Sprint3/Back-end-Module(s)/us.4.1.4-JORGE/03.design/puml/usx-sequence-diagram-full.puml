@startuml
skinparam monochrome true
skinparam shadowing false
title Class Diagram â€“ US4.1.4 Update Operation Plan

class OperationPlanController <<Controller>> {
  +getPlan(vvnId: string, planDate: Date): HttpResponse
  +updatePlan(vvnId: string, dto: UpdateOperationPlanDto, ifMatch?: string): HttpResponse
  +getAudit(vvnId: string, planDate: Date): HttpResponse
}

class OperationPlanService <<ApplicationService>> {
  +getPlan(vvnId: string, planDate: Date): Result<OperationPlanDTO>
  +updatePlan(vvnId: string, dto: UpdateOperationPlanDto, author: string, ifMatch?: string): Result<OperationPlanDTO>
  +getAudit(vvnId: string, planDate: Date): Result<AuditEntryDTO[]>
}

class OperationPlanRepo <<Repository>> {
  +findByVvnAndDate(vvnId: string, planDate: Date): Promise<OperationPlan | null>
  +save(plan: OperationPlan): Promise<void>
}

class OperationPlanAuditRepo <<Repository>> {
  +append(entry: OperationPlanChangeLog): Promise<void>
  +findByVvnAndDate(vvnId: string, planDate: Date): Promise<OperationPlanChangeLog[]>
}

class OperationPlanConsistencyChecker <<DomainService>> {
  +check(plan: OperationPlan): Promise<{warnings: Warning[], conflicts: Conflict[]}>
}

class OperationPlanMap <<Mapper>> {
  +toDTO(plan: OperationPlan, warnings?: Warning[]): OperationPlanDTO
}

class OperationPlan <<AggregateRoot>> {
  -props: OperationPlanProps
  +applyPatch(opsPatch: OperationPatch[], status?: string): Result<void>
}

class Operation <<Entity>> {
  +operationId: string
  +startTime: number
  +endTime: number
  +crane: string
  +craneCountUsed: number
  +staffAssignments: StaffAssignment[]
}

class OperationPlanChangeLog <<Entity>> {
  +logId: string
  +changedAt: Date
  +author: string
  +reasonForChange: string
  +diffSummary: string
}

OperationPlanController --> OperationPlanService
OperationPlanService --> OperationPlanRepo
OperationPlanService --> OperationPlanAuditRepo
OperationPlanService --> OperationPlanConsistencyChecker
OperationPlanService --> OperationPlanMap

OperationPlan "1" *-- "0..*" Operation
OperationPlan "1" *-- "0..*" OperationPlanChangeLog

@enduml