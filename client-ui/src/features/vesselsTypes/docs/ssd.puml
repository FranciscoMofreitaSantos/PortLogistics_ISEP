@startuml
' ==========================================================
' Sequence Diagram – US2.2.1 (Create and Manage Vessel Types)
' Author: Jorge Ubaldo Rodrigues
' Context: Port Management – Vessel Type Module
' Includes: SPA Frontend + API + Domain + Persistence
' ==========================================================

' ========= Actors =========
actor "Port Authority Officer" as Officer

' ========= Frontend / SPA Layer =========
boundary "SPA VesselTypeListPage\n(/vessel-types)" as SPAList
control  "useVesselTypes hook" as Hook
control  "VesselTypeSearchBar" as SearchBar
control  "VesselTypeTable" as Table
boundary "VesselTypeSlideDetails" as SlideDetails
boundary "VesselTypeCreateModal" as CreateModal
boundary "VesselTypeEditModal" as EditModal
boundary "VesselTypeDeleteModal" as DeleteModal
control  "Frontend Service\n(vesselTypeService.ts)" as FEService
boundary "HTTP ApiClient\n(axios)" as ApiClient

' ========= Backend / API & Domain =========
boundary "API Layer\n(Controller)\n<<uses IVesselTypeService>>" as Controller
control  "Application Layer\n(VesselTypeService)\n(implements IVesselTypeService)" as Service
control  "Mapper\n(VesselTypeMappers)" as Mappers
control  "Factory\n(VesselTypeFactory)" as Factory
entity   "Repository\n<<interface>>\n(IVesselTypeRepository)" as Repo
entity   "UnitOfWork\n<<interface>>\n(IUnitOfWork)" as UoW
collections "Audit/Logs\n(ILogger / Serilog)" as Log


' ==========================================================
' 0) INITIAL LOAD – LIST ALL VESSEL TYPES
' ==========================================================
== Initial Load – List Vessel Types ==

Officer -> SPAList : Navigate to /vessel-types
activate SPAList

SPAList -> Hook : init() / useVesselTypes()
activate Hook

Hook -> FEService : apiGetVesselTypes()
activate FEService

FEService -> ApiClient : GET /api/vesseltypes
activate ApiClient

ApiClient -> Controller : GET /api/vesseltypes
activate Controller

Controller -> Service : GetAllAsync()
activate Service

Service -> Repo : GetAllAsync()
activate Repo
Repo --> Service : List<VesselType> (entities)
deactivate Repo

Service -> Mappers : ToDto(list)
activate Mappers
Mappers --> Service : List<VesselTypeDto>
deactivate Mappers

Service -> Log : Log(READ_ALL, officerId, count, SUCCESS)
Service --> Controller : List<VesselTypeDto>
deactivate Service

Controller --> ApiClient : 200 OK (List<VesselTypeDto>)
deactivate Controller

ApiClient --> FEService : List<VesselTypeResponseDto>
deactivate ApiClient

FEService --> Hook : map to VesselType (domain for UI)
deactivate FEService

Hook -> SPAList : setItems(list) & setFiltered(list)
deactivate Hook

SPAList -> SearchBar : render with items
SPAList -> Table : render with filtered items
SPAList --> Officer : Vessel type list visible
deactivate SPAList


' ==========================================================
' 1) CREATE VESSEL TYPE
' ==========================================================
== Create ==

Officer -> SPAList : Click "+ Add Vessel Type"
activate SPAList
SPAList -> CreateModal : open()
deactivate SPAList

activate CreateModal
Officer -> CreateModal : Fill form\n(name, description, bays, rows, tiers)\nclick "Save"

CreateModal -> FEService : apiCreateVesselType(CreateVesselTypeDto)
activate FEService

FEService -> ApiClient : POST /api/vesseltypes\nBody: CreateVesselTypeDto
activate ApiClient

ApiClient -> Controller : POST /api/vesseltypes\nBody: CreateVesselTypeDto
activate Controller

Controller -> Service : AddAsync(dto)\n<<IVesselTypeService.AddAsync>>
activate Service

Service -> Repo : GetByNameAsync(dto.Name)
activate Repo
Repo --> Service : null (no duplicate found)
deactivate Repo

Service -> Service : Validate name & constraints
Service -> Factory : CreateBasicVesselType(dto)
activate Factory
Factory --> Service : VesselType (entity)
deactivate Factory

Service -> Repo : AddAsync(entity)
activate Repo
Repo --> Service : Entity tracked
deactivate Repo

Service -> UoW : CommitAsync()
activate UoW
UoW --> Service : Transaction committed
deactivate UoW

Service -> Mappers : CreateDtoVesselType(entity)
activate Mappers
Mappers --> Service : VesselTypeDto
deactivate Mappers

Service -> Log : Log(CREATE, officerId, vesselTypeId, SUCCESS)
Service --> Controller : VesselTypeDto
deactivate Service

Controller --> ApiClient : 201 Created (VesselTypeDto)
deactivate Controller

ApiClient --> FEService : VesselTypeResponseDto
deactivate ApiClient

FEService --> CreateModal : created dto
deactivate FEService

CreateModal -> SPAList : toast success + onCreated()
CreateModal -> CreateModal : close()
deactivate CreateModal

' Reload list after creation (reuse Initial Load flow simplificado)
activate SPAList
SPAList -> Hook : reload()
activate Hook
Hook -> FEService : apiGetVesselTypes()
activate FEService
FEService -> ApiClient : GET /api/vesseltypes
ApiClient -> Controller : GET /api/vesseltypes
Controller -> Service : GetAllAsync()
Service -> Repo : GetAllAsync()
Repo --> Service : List<VesselType>
Service -> Mappers : ToDto(list)
Mappers --> Service : List<VesselTypeDto>
Service --> Controller : List<VesselTypeDto>
Controller --> ApiClient : 200 OK
ApiClient --> FEService : List<VesselTypeResponseDto>
deactivate ApiClient
FEService --> Hook : map to VesselType[]
deactivate FEService
Hook -> SPAList : update items & filtered
deactivate Hook
SPAList --> Officer : list updated with new Vessel Type
deactivate SPAList


' ==========================================================
' 1.1) CREATE – ERROR: DUPLICATE NAME
' ==========================================================
== Create – Duplicate Name Error ==

Officer -> CreateModal : Save with existing Name
activate CreateModal

CreateModal -> FEService : apiCreateVesselType(dto)
activate FEService

FEService -> ApiClient : POST /api/vesseltypes
activate ApiClient

ApiClient -> Controller : POST /api/vesseltypes
activate Controller

Controller -> Service : AddAsync(dto)
activate Service

Service -> Repo : GetByNameAsync(dto.Name)
activate Repo
Repo --> Service : Existing VesselType
deactivate Repo

Service -> Service : throw BusinessRuleValidationException("Name already exists")
Service -> Log : Log(CREATE, officerId, dto.Name, FAILED_DUPLICATE)
deactivate Service

Controller --> ApiClient : 409 Conflict (BusinessRuleValidationException)
deactivate Controller

ApiClient --> FEService : 409 Conflict
deactivate ApiClient

FEService --> CreateModal : error
deactivate FEService

CreateModal -> CreateModal : show toast "Name already exists"
CreateModal --> Officer : validation error in UI
deactivate CreateModal


' ==========================================================
' 2) UPDATE VESSEL TYPE
' ==========================================================
== Update ==

Officer -> Table : Click row (select vessel type)
activate Table
Table -> SPAList : onSelect(vesselType)
deactivate Table

SPAList -> SlideDetails : open with selected
activate SlideDetails
Officer -> SlideDetails : Click "Edit"
SlideDetails -> EditModal : open(selected)
deactivate SlideDetails

activate EditModal
Officer -> EditModal : Change fields & click "Save"

EditModal -> FEService : apiUpdateVesselType(id, UpdateVesselTypeDto)
activate FEService

FEService -> ApiClient : PUT /api/vesseltypes/{id}\nBody: UpdateVesselTypeDto
activate ApiClient

ApiClient -> Controller : PUT /api/vesseltypes/{id}
activate Controller

Controller -> Service : UpdateAsync(id, dto)\n<<IVesselTypeService.UpdateAsync>>
activate Service

Service -> Repo : GetByIdAsync(id)
activate Repo
Repo --> Service : VesselType (existing entity)
deactivate Repo

Service -> Service : Validate updates\n(unique name, positive dimensions)
Service -> Repo : Save(updated entity)\n<<Update/Save>>
activate Repo
Repo --> Service : Entity updated
deactivate Repo

Service -> UoW : CommitAsync()
activate UoW
UoW --> Service : Transaction committed
deactivate UoW

Service -> Mappers : CreateDtoVesselType(updated)
activate Mappers
Mappers --> Service : VesselTypeDto
deactivate Mappers

Service -> Log : Log(UPDATE, officerId, vesselTypeId, SUCCESS)
Service --> Controller : VesselTypeDto
deactivate Service

Controller --> ApiClient : 200 OK (VesselTypeDto)
deactivate Controller

ApiClient --> FEService : VesselTypeResponseDto
deactivate ApiClient

FEService --> EditModal : updated dto
deactivate FEService

EditModal -> SPAList : toast success + onUpdated()
EditModal -> EditModal : close()
deactivate EditModal

SPAList -> Hook : reload()   ' (mesmo padrão de reload)
Hook -> FEService : apiGetVesselTypes()
FEService -> ApiClient : GET /api/vesseltypes
ApiClient -> Controller : GET /api/vesseltypes
Controller -> Service : GetAllAsync()
Service -> Repo : GetAllAsync()
Repo --> Service : List<VesselType>
Service -> Mappers : ToDto(list)
Mappers --> Service : List<VesselTypeDto>
Service --> Controller : List<VesselTypeDto>
Controller --> ApiClient : 200 OK
ApiClient --> FEService : List<VesselTypeResponseDto>
FEService --> Hook : map to VesselType[]
Hook -> SPAList : update items & filtered
SPAList --> Officer : updated vessel type shown


' ==========================================================
' 3) DELETE VESSEL TYPE
' ==========================================================
== Delete ==

Officer -> SlideDetails : Click "Delete"
activate SlideDetails
SlideDetails -> DeleteModal : open(selected)
deactivate SlideDetails

activate DeleteModal
Officer -> DeleteModal : Confirm delete

DeleteModal -> FEService : apiDeleteVesselType(id)
activate FEService

FEService -> ApiClient : DELETE /api/vesseltypes/{id}
activate ApiClient

ApiClient -> Controller : DELETE /api/vesseltypes/{id}
activate Controller

Controller -> Service : DeleteAsync(id)\n<<IVesselTypeService.DeleteAsync>>
activate Service

Service -> Repo : GetByIdAsync(id)
activate Repo
Repo --> Service : VesselType or null
deactivate Repo

Service -> Repo : Remove(entity)
activate Repo
Repo --> Service : removed
deactivate Repo

Service -> UoW : CommitAsync()
activate UoW
UoW --> Service : Transaction committed
deactivate UoW

Service -> Log : Log(DELETE, officerId, vesselTypeId, SUCCESS)
Service --> Controller : 204 NoContent
deactivate Service

Controller --> ApiClient : 204 NoContent
deactivate Controller

ApiClient --> FEService : success
deactivate ApiClient

FEService --> DeleteModal : ok
deactivate FEService

DeleteModal -> SPAList : toast success + onDeleted()
DeleteModal -> DeleteModal : close()
deactivate DeleteModal

SPAList -> Hook : reload()
Hook -> FEService : apiGetVesselTypes()
FEService -> ApiClient : GET /api/vesseltypes
ApiClient -> Controller : GET /api/vesseltypes
Controller -> Service : GetAllAsync()
Service -> Repo : GetAllAsync()
Repo --> Service : List<VesselType>
Service -> Mappers : ToDto(list)
Mappers --> Service : List<VesselTypeDto>
Service --> Controller : List<VesselTypeDto>
Controller --> ApiClient : 200 OK
ApiClient --> FEService : List<VesselTypeResponseDto>
FEService --> Hook : map to VesselType[]
Hook -> SPAList : update items & filtered
SPAList --> Officer : list without deleted type


' ==========================================================
' 4) SEARCH VESSEL TYPES (LOCAL VS REMOTE)
' ==========================================================
== Search (Local / Remote) ==

Officer -> SearchBar : Type query and press Enter / Search
activate SearchBar

alt Local search (client-side)
    SearchBar -> SearchBar : filter in-memory list\nby name/description
    SearchBar -> SPAList : onFilteredChange(filtered)
    SPAList -> Table : render filtered items
    SPAList --> Officer : filtered list (no API call)
else Remote search by name
    SearchBar -> FEService : apiGetVesselTypeByName(name)
    activate FEService

    FEService -> ApiClient : GET /api/vesseltypes/name/{name}
    activate ApiClient

    ApiClient -> Controller : GET /api/vesseltypes/name/{name}
    activate Controller

    Controller -> Service : GetByNameAsync(name)
    activate Service

    Service -> Repo : GetByNameAsync(name)
    activate Repo
    Repo --> Service : VesselType or null
    deactivate Repo

    alt found
        Service -> Mappers : CreateDtoVesselType(entity)
        activate Mappers
        Mappers --> Service : VesselTypeDto
        deactivate Mappers

        Service -> Log : Log(SEARCH_BY_NAME, officerId, name, SUCCESS)
        Service --> Controller : VesselTypeDto
    else not found
        Service -> Log : Log(SEARCH_BY_NAME, officerId, name, NOT_FOUND)
        Service --> Controller : 404 Not Found
    end
    deactivate Service

    Controller --> ApiClient : 200 OK or 404
    deactivate Controller

    ApiClient --> FEService : dto or error
    deactivate ApiClient

    alt 200 OK
        FEService --> SearchBar : VesselTypeResponseDto
        deactivate FEService

        SearchBar -> SPAList : onFilteredChange([mapped])
        SPAList -> Table : render single result
        SPAList --> Officer : single vessel type shown
    else 404 Not Found
        FEService --> SearchBar : null / error
        deactivate FEService

        SearchBar -> SPAList : onFilteredChange([])
        SPAList -> Table : show "No results"
        SPAList --> Officer : feedback "No vessel types found"
    end
end

deactivate SearchBar

@enduml
